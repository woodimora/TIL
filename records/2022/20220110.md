# JPA Bulk 작업 주의점
한 트랜잭션에서 벌크 연산후 데이터가 변하지않는 현상이 있다.

## JPA의 업데이트 메커니즘
JPA가 엔티티의 변경사항을 데이터베이스에 반영하는 것을 변경감지(dirty check) 를 통해서 업데이트한다. JPA는 엔티티를 영속성 컨텍스트에 보관할 때, 최초 상태를 복사해서 저장해두고, 플러시 시점에서 스냅샷과 엔티티를 비교해서 변경된 엔티티를 데이터베이스에 반영하게 된다.

## 벌크 수정 메커니즘
벌크성 작업은 영속성 컨텍스트와 무관하다. 벌크 연산은 영속성 컨텍스트를 통하지 않고 데이터베이스에 직접 쿼리를 진행한다. 즉 영속성 컨텍스트에 존재하는 Team의 name들은 변경이 없는 것이다.

영속성 컨텍스트를 먼저 찾고 영속성 컨텍스트에 해당 엔티티가 있으면 그값을 바로 리턴한다. 반면 JPQL은 영속성 컨텍스트를 먼저 조회하지 않고 데이터베이스에 query하여 결과를 가져온다. 그리고 아래와 같은 흐름으로 영속성 컨텍스트를 저장을 시도한다.

1. JPQL을 호출하면 데이터베이스에서 우선적으로 조회한다.
2. 조회한 값을 영속성 컨테스트에 저장을 시도하는데 데이터가 이미 영속성 컨텍스트에 존재하는 경우(영속성 컨턱스트는 식별자 값으로 식별)에는 데이터베이스에서 조회한 신규 데이터를 버린다.

이미 영속성 컨텍스트에 조회가 되었기 때문에 신규 조회한 영속성 컨텍스트를 버리기 때문에 데이터가 변하지 않는다.

## 해결방법
영속성 컨텍스트를 초기화(clear)하면 된다.